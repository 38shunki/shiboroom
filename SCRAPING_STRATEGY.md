# スクレイピング戦略ドキュメント

## 現状の問題

### WAFブロック確認（2025-12-17）
```
HTTP/2 500
Title: Yahoo! JAPAN - ご覧になろうとしているページは現在表示できません
Message: 一時的なエラーですので、しばらく時間をおいてから再度お試しください
```

**診断結果**: Yahoo! JAPANのWAFによる完全ブロック
- 固定サイズ (4913 bytes) のエラーページ
- すべてのリクエストが500エラー
- IP単位でのブロック可能性が高い

## 実装した安全装置（2025-12-18 バースト制御強化）

### 1. グローバルレート制御 (`ratelimit/yahoo_limiter.go`)
```go
maxInFlight:  1                    // 同時HTTP接続数（バースト回避）
baseDelay:    2500ms              // 基本待機時間（増加）
jitter:       0-1500ms            // ランダム揺らぎ（合計: 2.5-4.0秒）
```

**変更理由**: 50件でブロックされる原因は「短時間の累積リクエスト量」
- 並列度を2→1に削減（バースト密度を半減）
- 平均間隔を1.25秒→3.25秒に増加（密度をさらに削減）

### 2. サーキットブレーカー (`scraper/circuit_breaker.go`)
```go
failureThreshold: 40%             // 20リクエスト中8件失敗で発動（厳格化）
resetTimeout:     1 hour          // 1時間後に再試行
```

**変更理由**: 早期検知でブロック深刻化を防ぐ
- 閾値を75%→40%に厳格化
- 最初の1-2発で撤退できる

**動作**:
- 500/503/429/403エラーを記録
- 失敗率40%でスクレイピング自動停止
- ログに警告メッセージ出力
- 1時間後に自動復帰試行

### 3. 詳細取得上限 + キューシステム（NEW - 2025-12-18）
```go
MaxDetailScrapePerRun = 20        // 1実行あたり最大20件
detail_scrape_queue テーブル     // 繰り越しの実体
```

**変更理由**: "50件でブロック"を"20件で安全停止"に変更
- ✅ 新規物件を `detail_scrape_queue` に追加
- ✅ 毎回キューから20件だけ処理
- ✅ 失敗時は自動リトライ（指数バックオフ: 5分→15分→1時間→4時間→12時間）
- ✅ 5回失敗で永久失敗マーク
- ✅ 「全部取る」→「少しずつ確実に取る」へ

**キューテーブル構造**:
```sql
detail_scrape_queue (
  source, source_property_id, detail_url,
  status (pending/processing/done/failed),
  attempts, last_error, next_retry_at
)
```

### 4. 連続エラー即停止（NEW - 2025-12-18）
```go
consecutiveFailures >= 2 && (status == 500|429|403) → 即Open
```

**変更理由**: WAFブロックは「成功→突然全滅」パターン
- ✅ 連続2回の500/429/403で即座に停止
- ✅ 「深追いして完全ブロック」を回避
- ✅ 失敗率40%は保険として維持

### 5. 指数バックオフ強化
- 通常エラー: 2s → 4s → 8s → 16s (最大60s)
- サーバーエラー: 8s → 16s → 32s → 60s

## 物件の同一性キー（2025-12-17 実装完了）

**実装方法**: Yahoo物件IDベースの安定した識別

### データモデル
```go
type Property struct {
    ID               string // 内部主キー (MD5 of "source:source_property_id")
    Source           string // データソース (e.g., "yahoo")
    SourcePropertyID string // Yahoo物件ID (48文字の16進数)
    DetailURL        string // 詳細ページURL
    // ...
}
```

### UNIQUE制約
```sql
UNIQUE INDEX idx_source_property (source, source_property_id)
```

### ID抽出ロジック
- URL: `https://realestate.yahoo.co.jp/rent/detail/000008250678c0a0c9accff94eab13c4c687966f0698`
- 抽出ID: `000008250678c0a0c9accff94eab13c4c687966f0698`
- 検証: 48文字の16進数文字列であることを確認
- フォールバック: 非標準URLの場合はMD5ハッシュを使用

### メリット
✅ **差分取得の安定性**: Yahoo IDは不変なので、URLパラメータ変更の影響を受けない
✅ **WAF対策との相性**: 既存物件を1リクエスト前に判定可能（無駄な詳細取得が激減）
✅ **拡張性**: 将来的に他サイト追加時も同じパターンで対応可能
✅ **デバッグ容易性**: ログにYahoo IDが出ればブラウザで直接確認できる

## 推奨運用方針（2025-12-18 改訂）

### バースト制御戦略（最優先 - 実装済み）

**診断結果**: 「50件でブロック」= 短時間の累積リクエスト量が閾値超過

#### 対策1: 詳細取得上限（✅ 実装完了）
- 1回の実行で詳細取得は**最大20件**
- 残りは次回に繰り越し
- 「新着が多い日」でもブロックされない

#### 対策2: 実行頻度の分散（推奨）
従来: **1日1回** の大量取得（1,000件）
改善: **毎時実行**（最大20件/時）

```bash
# cron設定例
0 * * * *  bash /var/www/shiboroom/scrape-incremental.sh
```

**効果**:
- 1日で24回に分散 = バースト密度が1/24
- 1回あたり20件 × 24回 = 480件/日（十分）
- ブロックリスクが激減

#### 対策3: レート制限強化（✅ 実装完了）
- 同時接続: 2 → **1**
- 平均間隔: 1.25秒 → **3.25秒**
- 「速い」より「止まらない」が正義

### 短期対策（実装済み）
1. ✅ **冷却期間管理** (`scraping_state`テーブル)
   - ブロック検知時に24時間の冷却期間を設定
   - cron実行時に`blocked_until`をチェックして自動スキップ
   - WAFに「毎日殴る」と認識されない

2. ✅ **掲載終了検知** (3段階)
   - **レベル1**: `last_seen_at` が7日以上→「不明」ラベル
   - **レベル2**: 14日以上→「終了扱い」
   - **レベル3**: 取得可能な日に候補物件だけ詳細確認

3. ✅ **差分取得重視**
   - 一覧ページから消えた物件→検証キューへ
   - 新規物件のみ詳細取得（最大20件）
   - 既存物件は`last_seen_at`更新のみ

### 中期対策（検討中）
1. **ヘッダー改善**:
   ```go
   User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
   Accept: text/html,application/xhtml+xml,application/xml;q=0.9
   Accept-Language: ja,en-US;q=0.9
   Referer: https://realestate.yahoo.co.jp/rent/search/...
   ```

2. **取得頻度の最適化**
   - 全件取得: 週1回
   - 差分取得: 1日1回
   - 生存確認: ブロックされてない日のみ

3. **プロキシ経由**
   - 複数IPアドレスでリスク分散
   - Residential Proxyの利用

### 長期対策（根本解決）
1. **公式APIの利用検討**
2. **データ提供サービスとの契約**
3. **RSSフィードの活用**

## スクレイピング実行ガイド

### テスト実行（少量）
```bash
ssh grik@162.43.74.38 "bash /tmp/test-scrape.sh"
```

### 本番実行（1,000件）
```bash
ssh grik@162.43.74.38 "bash /var/www/shiboroom/scrape-tokyo-23.sh"
```

### ログ監視
```bash
# バックエンドログ
ssh grik@162.43.74.38 "journalctl -u shiboroom-backend -f"

# スクレイピングログ
ssh grik@162.43.74.38 "tail -f /var/www/shiboroom/logs/scraping.log"
```

### 緊急停止
```bash
ssh grik@162.43.74.38 "pkill -f scrape-tokyo-23"
```

## サーキットブレーカーの確認方法

ログに以下のメッセージが出たら自動停止しています:
```
⚠️  CIRCUIT BREAKER OPEN: Failure rate 75.0% (15/20 failures). Suspected WAF block.
⚠️  Scraping halted. Will retry after 1h0m0s
```

その後のリクエストは以下のエラーで拒否されます:
```
circuit breaker open: suspected WAF block (15/20 failures, open=true)
```

## 現在の状態

**ステータス**: ✅ バースト制御完全実装完了
**最終更新**: 2025-12-18 04:30 JST

### 実装完了項目

#### コア機能
- ✅ レート制限強化（inFlight=1, 2.5-4.0秒間隔）
- ✅ 詳細取得上限（20件/実行）
- ✅ サーキットブレーカー閾値厳格化（40%）
- ✅ 連続エラー即停止（2連続500/429/403）
- ✅ キューシステム実装（detail_scrape_queue）
- ✅ 自動リトライ機構（指数バックオフ）

#### データベース
- ✅ マイグレーション作成（005_create_detail_scrape_queue.sql）
- ✅ GORM AutoMigrate統合

### 推奨運用

**実行頻度**: **毎時** (1日24回)
**1回あたり上限**: 最大20件の詳細取得
**推定処理能力**: 480件/日（ブロックなし想定）
**所要時間**: 約2-4分/回（平均3.25秒 × 20件）

### 期待される効果

| 項目 | 改善 |
|------|------|
| **バースト密度** | 1/24に削減（毎時分散） |
| **リクエスト密度** | 1/8に削減（inFlight+間隔） |
| **合計リスク** | **約1/200に削減** |
| **ブロック回避** | 2連続エラーで即停止 |
| **データ鮮度** | 毎時更新で大幅向上 |
| **継続性** | キューで「いつか全部取れる」保証 |
