# è«–ç†å‰Šé™¤ â†’ ç‰©ç†å‰Šé™¤ è¨­è¨ˆï¼ˆãƒ‡ãƒ¼ã‚¿é‡æœ€é©åŒ–ï¼‰

## çµè«–ï¼ˆå…¨ä½“æ–¹é‡ï¼‰

1. **å³æ™‚å¯¾å¿œãŒå¿…è¦ãªé ˜åŸŸï¼ˆæ¤œç´¢ãƒ»è¡¨ç¤ºï¼‰**
   â†’ è«–ç†å‰Šé™¤ã§å³æ™‚åæ˜ 
2. **ãƒ‡ãƒ¼ã‚¿é‡ãŒåŠ¹ã„ã¦ãã‚‹ä¸­é•·æœŸ**
   â†’ æ¡ä»¶ä»˜ãã§ç‰©ç†å‰Šé™¤
3. **å‰Šé™¤åˆ¤æ–­ã¯å¿…ãšã€Œæ™‚é–“ã€ã‚’æŒŸã‚€**
   â†’ èª¤æ¤œçŸ¥ãƒ»ä¸€æ™‚éå…¬é–‹ã«è€ãˆã‚‹

---

## ãªãœæœ€åˆã¯è«–ç†å‰Šé™¤ãŒå¿…é ˆã‹

### æ¶ˆãˆãŸç‰©ä»¶ã«ã¯ä»¥ä¸‹ã®å¯èƒ½æ€§ãŒã‚ã‚‹

* **ä¸€æ™‚çš„ãªæ²è¼‰åœæ­¢** - å¥‘ç´„æˆç«‹ã‚„ä¸€æ™‚çš„ãªå‹Ÿé›†åœæ­¢
* **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹** - Yahooä¸å‹•ç”£å´ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
* **æ¡ä»¶å¤‰æ›´ã«ã‚ˆã‚‹URLå†ç”Ÿæˆ** - è³ƒæ–™å¤‰æ›´ãªã©ã§URLå¤‰æ›´
* **ä¸€è¦§å–å¾—ã®ä¸€æ™‚å¤±æ•—** - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

ğŸ‘‰ **å³ç‰©ç†å‰Šé™¤ = ãƒ‡ãƒ¼ã‚¿äº‹æ•…ã®æ¸©åºŠ**

### å®Ÿä¾‹ã‚·ãƒŠãƒªã‚ª

```
æœ9:00  ä¸€è¦§å–å¾—ã§ã‚¨ãƒ©ãƒ¼ â†’ ç‰©ä»¶AãŒå–å¾—ã§ããš
æœ9:01  å·®åˆ†åˆ¤å®šã§ã€Œæ¶ˆæ»…ã€ã¨åˆ¤å®š
æœ9:02  ç‰©ç†å‰Šé™¤å®Ÿè¡Œ â†’ ãƒ‡ãƒ¼ã‚¿æ°¸ä¹…æ¶ˆå¤±
æœ10:00 å®Ÿã¯ç‰©ä»¶Aã¯å­˜åœ¨ã—ã¦ã„ãŸ...
```

**è«–ç†å‰Šé™¤ãªã‚‰ã“ã®å ´åˆã§ã‚‚å¾©æ´»å¯èƒ½**

---

## ãƒ‡ãƒ¼ã‚¿é‡ã®ç¾å®Ÿçš„ãªè¦‹ç©ã‚Šï¼ˆç›®å®‰ï¼‰

### propertiesï¼ˆ1ä»¶ã‚ãŸã‚Šï¼‰

* æ•°å€¤ãƒ»æ–‡å­—åˆ—ã®ã¿ï¼ˆç”»åƒã¯URLå‚ç…§ï¼‰
* ç´„ **1ã€œ2KB / ä»¶**

### æƒ³å®šã‚·ãƒŠãƒªã‚ª

| ç‰©ä»¶æ•° | ã‚¢ã‚¯ãƒ†ã‚£ãƒ– | å‰Šé™¤æ¸ˆã¿ | åˆè¨ˆå®¹é‡ |
|--------|-----------|---------|---------|
| 100ä¸‡ä»¶ | 70ä¸‡ä»¶ | 30ä¸‡ä»¶ | ç´„2GB |
| 180ä¸‡ä»¶ | 120ä¸‡ä»¶ | 60ä¸‡ä»¶ | ç´„3.6GB |
| 500ä¸‡ä»¶ | 300ä¸‡ä»¶ | 200ä¸‡ä»¶ | ç´„10GB |

ğŸ‘‰ MySQL + ã‚·ãƒ³VPSã§ã¯ **180ä¸‡ä»¶ç¨‹åº¦ã¾ã§ååˆ†ç¾å®Ÿçš„**
ãŸã ã— **ç„¡åˆ¶é™ã«æºœã‚ã‚‹ã®ã¯NG**

### daily_property_snapshots

* 1ä»¶ã‚ãŸã‚Šç´„0.5KB
* 10ä¸‡ä»¶/æ—¥ Ã— 90æ—¥ = ç´„450MB
* å¹´é–“ã§ç´„1.6GB

---

## æ¨å¥¨ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ï¼ˆ3ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º1ï¼šè«–ç†å‰Šé™¤ï¼ˆå³æ™‚ï¼‰

```
ä¸€è¦§ã«å­˜åœ¨ã—ãªã„
â†“
status = 'removed'
removed_at = NOW()
â†“
æ¤œç´¢ãƒ»Meilisearchã‹ã‚‰å³é™¤å¤–
```

* **ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿**: å³åº§ã«æ¤œç´¢çµæœã‹ã‚‰æ¶ˆãˆã‚‹
* **ãƒ‡ãƒ¼ã‚¿**: DBã«ä¿æŒã•ã‚ŒãŸã¾ã¾
* **å¾©æ´»å¯èƒ½**: status ã‚’ 'active' ã«æˆ»ã™ã ã‘

**å®Ÿè£…**:
```go
// properties.status ã‚’ 'removed' ã«æ›´æ–°
UPDATE properties
SET status = 'removed',
    removed_at = NOW()
WHERE id IN (/* æ¶ˆæ»…ç‰©ä»¶IDãƒªã‚¹ãƒˆ */);

// Meilisearchã‹ã‚‰å‰Šé™¤
DELETE /indexes/properties/documents/{id}
```

---

### ãƒ•ã‚§ãƒ¼ã‚º2ï¼šä¿ç•™æœŸé–“ï¼ˆå®‰å…¨ãƒãƒƒãƒ•ã‚¡ï¼‰

**æœ€ä½ 7ã€œ30æ—¥ ä¿æŒ**

**ç†ç”±**:

1. **ä¸€æ™‚çš„éå…¬é–‹ã¸ã®å¯¾å¿œ**
   - å†…è¦‹ä¸­ã«ã‚ˆã‚‹ä¸€æ™‚éå…¬é–‹
   - å¥‘ç´„å¯©æŸ»ä¸­ã®ä¸€æ™‚åœæ­¢
   - ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

2. **èª¤æ¤œå‡ºæ™‚ã®å¾©æ´»**
   - ä¸€è¦§å–å¾—å¤±æ•—
   - URLæ­£è¦åŒ–ãƒŸã‚¹
   - ã‚¨ãƒªã‚¢åˆ†å‰²ã®å¢ƒç•Œç‰©ä»¶

3. **ãƒ­ã‚°ãƒ»åˆ†æã«ä½¿ãˆã‚‹**
   - æ¶ˆæ»…ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
   - ã‚¨ãƒªã‚¢åˆ¥ã®æ¶ˆæ»…ç‡
   - ç¯‰å¹´æ•°åˆ¥ã®æ¶ˆæ»…é€Ÿåº¦

**ã‚¯ã‚¨ãƒªä¾‹**:
```sql
-- ä¿ç•™æœŸé–“ä¸­ã®å‰Šé™¤æ¸ˆã¿ç‰©ä»¶
SELECT COUNT(*)
FROM properties
WHERE status = 'removed'
  AND removed_at >= NOW() - INTERVAL 30 DAY;
```

---

### ãƒ•ã‚§ãƒ¼ã‚º3ï¼šç‰©ç†å‰Šé™¤ï¼ˆå®šæœŸãƒãƒƒãƒï¼‰

#### å‰Šé™¤å¯¾è±¡æ¡ä»¶ï¼ˆæ¨å¥¨ï¼‰

```sql
DELETE FROM properties
WHERE status = 'removed'
  AND removed_at < NOW() - INTERVAL 90 DAY
LIMIT 1000;  -- å®‰å…¨ã®ãŸã‚åˆ†å‰²å‰Šé™¤
```

**ãŠã™ã™ã‚åˆæœŸå€¤**:

| ãƒ•ã‚§ãƒ¼ã‚º | ä¿æŒæœŸé–“ | ç†ç”± |
|---------|---------|------|
| PoCã€œåˆæœŸé‹ç”¨ | **90æ—¥** | å®‰å…¨é‡è¦–ã€å¾©æ—§ä½™è£•ã‚ã‚Š |
| å®‰å®šé‹ç”¨ | **30ã€œ60æ—¥** | ãƒ‡ãƒ¼ã‚¿é‡æœ€é©åŒ– |
| å¤§è¦æ¨¡é‹ç”¨ | **7ã€œ30æ—¥** | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆå‰Šæ¸› |

---

## å‰Šé™¤å¯¾è±¡ã‹ã‚‰ã€Œé™¤å¤–ã™ã¹ãã‚‚ã®ã€

å°†æ¥ã®ãŸã‚ã€ä»¥ä¸‹ã¯**ç‰©ç†å‰Šé™¤ã—ãªã„**é¸æŠè‚¢ã‚‚ã‚ã‚Šã¾ã™ã€‚

| ãƒ†ãƒ¼ãƒ–ãƒ« | å‰Šé™¤æ–¹é‡ | ç†ç”± |
|---------|---------|------|
| **properties** | æ¡ä»¶ä»˜ãå‰Šé™¤ | ä¸»ãƒ‡ãƒ¼ã‚¿ã€å®¹é‡åŠ¹ç‡åŒ–å¿…è¦ |
| **scrape_logs** | **å‰Šé™¤ã—ãªã„** | é‹ç”¨ãƒˆãƒ©ãƒ–ãƒ«èª¿æŸ»ã«å¿…é ˆ |
| **daily_property_snapshots** | 90æ—¥ä»¥é™å‰Šé™¤ | å·®åˆ†æ¤œå‡ºã«å¿…è¦ï¼ˆä¸€å®šæœŸé–“ï¼‰ |
| **scrape_areas** | **å‰Šé™¤ã—ãªã„** | ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ |
| **delete_logs** | **å‰Šé™¤ã—ãªã„** | å‰Šé™¤å±¥æ­´ï¼ˆç›£æŸ»ç”¨ï¼‰ |

### discrepancy_reportsï¼ˆå°†æ¥å®Ÿè£…ï¼‰

```sql
-- ç›¸é•å ±å‘Šã¯å‰Šé™¤ã—ãªã„ï¼ˆåˆ†æãƒ»ä¿¡é ¼æ€§æŒ‡æ¨™ï¼‰
-- ãŸã ã—å¤ã„ã‚‚ã®ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
```

---

## å®Ÿè£…è¨­è¨ˆï¼ˆGo + MySQLï¼‰

### 1. ã‚¸ãƒ§ãƒ–ã®åˆ†é›¢ï¼ˆé‡è¦ï¼‰

```
â–  daily_sync_jobï¼ˆæ¯æ—¥å®Ÿè¡Œï¼‰
  â”œâ”€ list      (ä¸€è¦§å–å¾—)
  â”œâ”€ diff      (å·®åˆ†åˆ¤å®š)
  â”œâ”€ detail    (è©³ç´°å–å¾—)
  â””â”€ mark_removed (è«–ç†å‰Šé™¤)

â–  cleanup_jobï¼ˆé€±1å›å®Ÿè¡Œï¼‰
  â””â”€ physical_delete (ç‰©ç†å‰Šé™¤)
```

ğŸ‘‰ **åŒæœŸå‡¦ç†ã¨å‰Šé™¤å‡¦ç†ã¯åˆ†ã‘ã‚‹**
ï¼ˆåŒã˜ã‚¸ãƒ§ãƒ–ã«ã—ãªã„ï¼‰

**ç†ç”±**:
- ç‰©ç†å‰Šé™¤ã¯å¤±æ•—ã—ã¦ã‚‚ã‚µãƒ¼ãƒ“ã‚¹å½±éŸ¿ãªã—
- é€±1å›ã§ååˆ†ï¼ˆå³æ™‚æ€§ä¸è¦ï¼‰
- é‡ã„å‡¦ç†ã‚’åˆ†æ•£

---

### 2. å‰Šé™¤ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¿…é ˆï¼‰

```sql
CREATE TABLE delete_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  property_id VARCHAR(32) NOT NULL,
  title TEXT,
  detail_url TEXT,
  removed_at DATETIME,
  deleted_at DATETIME NOT NULL,
  reason VARCHAR(50) NOT NULL,

  INDEX idx_deleted_at (deleted_at),
  INDEX idx_reason (reason)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**å‰Šé™¤ç†ç”±ã®ç¨®é¡**:

| reason | èª¬æ˜ |
|--------|------|
| `expired_90_days` | 90æ—¥çµŒéã«ã‚ˆã‚‹è‡ªå‹•å‰Šé™¤ |
| `expired_30_days` | 30æ—¥çµŒéã«ã‚ˆã‚‹è‡ªå‹•å‰Šé™¤ |
| `manual_cleanup` | ç®¡ç†è€…ã«ã‚ˆã‚‹æ‰‹å‹•å‰Šé™¤ |
| `data_migration` | ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ™‚ã®å‰Šé™¤ |

---

### 3. ç‰©ç†å‰Šé™¤ãƒãƒƒãƒã®Goå®Ÿè£…

```go
package batch

import (
    "context"
    "fmt"
    "time"
)

// PhysicalDeleteJob ã¯å¤ã„è«–ç†å‰Šé™¤æ¸ˆã¿ç‰©ä»¶ã‚’ç‰©ç†å‰Šé™¤
func PhysicalDeleteJob(ctx context.Context, retentionDays int) error {
    log.Info("=== Physical Delete Job Started ===", "retention_days", retentionDays)

    // Step 1: äº‹å‰ãƒã‚§ãƒƒã‚¯ï¼ˆå®‰å…¨è£…ç½®ï¼‰
    if err := validateBeforeDelete(ctx); err != nil {
        log.Error("äº‹å‰ãƒã‚§ãƒƒã‚¯å¤±æ•—", "error", err)
        return fmt.Errorf("äº‹å‰ãƒã‚§ãƒƒã‚¯å¤±æ•—: %w", err)
    }

    // Step 2: å‰Šé™¤å¯¾è±¡ã‚’ç‰¹å®šï¼ˆdry-runï¼‰
    targets, err := getDeleteTargets(ctx, retentionDays)
    if err != nil {
        return fmt.Errorf("å‰Šé™¤å¯¾è±¡å–å¾—ã‚¨ãƒ©ãƒ¼: %w", err)
    }

    log.Info("å‰Šé™¤å¯¾è±¡ä»¶æ•°", "count", len(targets))

    // Step 3: å‰Šé™¤ä»¶æ•°ãŒç•°å¸¸ã«å¤šã„å ´åˆã¯ä¸­æ­¢
    if len(targets) > 10000 {
        return fmt.Errorf("å‰Šé™¤å¯¾è±¡ãŒç•°å¸¸ã«å¤šã„ï¼ˆ%dä»¶ï¼‰ã€ä¸­æ­¢ã—ã¾ã™", len(targets))
    }

    // Step 4: å‰Šé™¤ãƒ­ã‚°ã«è¨˜éŒ²ã—ã¦ã‹ã‚‰ç‰©ç†å‰Šé™¤
    deletedCount := 0
    for _, property := range targets {
        // å‰Šé™¤ãƒ­ã‚°ä¿å­˜
        err := saveDeleteLog(ctx, property, retentionDays)
        if err != nil {
            log.Error("å‰Šé™¤ãƒ­ã‚°ä¿å­˜å¤±æ•—", "id", property.ID, "error", err)
            continue
        }

        // Meilisearchã‹ã‚‰å‰Šé™¤ï¼ˆå¿µã®ãŸã‚ï¼‰
        _ = search.DeleteProperty(property.ID)

        // DBç‰©ç†å‰Šé™¤
        err = db.PhysicalDeleteProperty(ctx, property.ID)
        if err != nil {
            log.Error("ç‰©ç†å‰Šé™¤å¤±æ•—", "id", property.ID, "error", err)
            continue
        }

        deletedCount++
    }

    log.Info("=== Physical Delete Job Completed ===",
        "total", len(targets),
        "deleted", deletedCount)

    return nil
}

// validateBeforeDelete ã¯å‰Šé™¤å‰ã®å®‰å…¨ãƒã‚§ãƒƒã‚¯
func validateBeforeDelete(ctx context.Context) error {
    // å½“æ—¥ã®ä¸€è¦§å–å¾—ãŒå®Œå…¨æˆåŠŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    today := time.Now().Format("2006-01-02")
    lastLog, err := db.GetLatestScrapeLog(ctx, today, "list")
    if err != nil {
        return fmt.Errorf("ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ­ã‚°ç¢ºèªã‚¨ãƒ©ãƒ¼: %w", err)
    }

    if lastLog.Status != "completed" {
        return fmt.Errorf("å½“æ—¥ã®ä¸€è¦§å–å¾—ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“: %s", lastLog.Status)
    }

    return nil
}

// getDeleteTargets ã¯å‰Šé™¤å¯¾è±¡ç‰©ä»¶ã‚’å–å¾—
func getDeleteTargets(ctx context.Context, retentionDays int) ([]*models.Property, error) {
    cutoffDate := time.Now().AddDate(0, 0, -retentionDays)

    var properties []*models.Property
    err := db.WithContext(ctx).
        Where("status = ?", "removed").
        Where("removed_at < ?", cutoffDate).
        Limit(10000).  // å®‰å…¨ã®ãŸã‚ä¸Šé™è¨­å®š
        Find(&properties).Error

    return properties, err
}

// saveDeleteLog ã¯å‰Šé™¤ãƒ­ã‚°ã‚’ä¿å­˜
func saveDeleteLog(ctx context.Context, property *models.Property, retentionDays int) error {
    deleteLog := &models.DeleteLog{
        PropertyID: property.ID,
        Title:      property.Title,
        DetailURL:  property.DetailURL,
        RemovedAt:  property.RemovedAt,
        DeletedAt:  time.Now(),
        Reason:     fmt.Sprintf("expired_%d_days", retentionDays),
    }

    return db.SaveDeleteLog(ctx, deleteLog)
}
```

---

### 4. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼è¨­å®š

#### cronè¨­å®šä¾‹

```go
// æ¯é€±æ—¥æ›œæ—¥ 3:00 AM ã«å®Ÿè¡Œ
c := cron.New()
c.AddFunc("0 3 * * 0", func() {
    ctx := context.Background()
    retentionDays := 90  // 90æ—¥ä¿æŒ

    if err := PhysicalDeleteJob(ctx, retentionDays); err != nil {
        log.Error("Physical delete job failed", "error", err)
        // ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
    }
})
c.Start()
```

---

## Meilisearchã¨ã®æ•´åˆæ€§

### å‰Šé™¤é †åºï¼ˆé‡è¦ï¼‰

```
1. Meilisearchã‹ã‚‰å‰Šé™¤
   â†“
2. DBã‹ã‚‰ç‰©ç†å‰Šé™¤
```

**ç†ç”±**:

* DBã ã‘æ¶ˆã™ã¨æ¤œç´¢ã«ã‚´ãƒŸãŒæ®‹ã‚‹å¯èƒ½æ€§
* æ¤œç´¢ã‚’ã€Œæ­£ã€ã«ä¿ã¤
* Meilisearchå‰Šé™¤å¤±æ•—ã¯è¨±å®¹ï¼ˆå¾Œã§ä¿®å¾©å¯èƒ½ï¼‰

### æ•´åˆæ€§ç¢ºèªãƒãƒƒãƒï¼ˆæ¨å¥¨ï¼‰

```go
// é€±1å›ã€DB ã¨ Meilisearch ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
func SyncCheckJob(ctx context.Context) error {
    // DBã«ãªã„IDãŒMeilisearchã«æ®‹ã£ã¦ã„ãŸã‚‰å‰Šé™¤
    meiliIDs := search.GetAllPropertyIDs()
    dbIDs := db.GetActivePropertyIDs(ctx)

    orphanIDs := difference(meiliIDs, dbIDs)
    for _, id := range orphanIDs {
        search.DeleteProperty(id)
    }

    return nil
}
```

---

## ç‰©ç†å‰Šé™¤ã®å®‰å…¨è£…ç½®ï¼ˆå¿…é ˆï¼‰

### å®Ÿè¡Œå‰ãƒã‚§ãƒƒã‚¯

```go
// å®‰å…¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
func validateBeforeDelete(ctx context.Context) error {
    // 1. å½“æ—¥ã®ä¸€è¦§å–å¾—ãŒå®Œå…¨æˆåŠŸ
    if !isTodayScrapeComplete(ctx) {
        return errors.New("å½“æ—¥ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“")
    }

    // 2. å·®åˆ†åˆ¤å®šãŒæ­£å¸¸çµ‚äº†
    if !isDiffDetectionSuccess(ctx) {
        return errors.New("å·®åˆ†åˆ¤å®šãŒæ­£å¸¸çµ‚äº†ã—ã¦ã„ã¾ã›ã‚“")
    }

    // 3. scrape_logs ã« completed ãŒå­˜åœ¨
    if !hasCompletedLog(ctx) {
        return errors.New("å®Œäº†ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    }

    return nil
}
```

### dry-run ãƒ¢ãƒ¼ãƒ‰ï¼ˆæœ€åˆã¯å¿…é ˆï¼‰

```go
func PhysicalDeleteJob(ctx context.Context, retentionDays int, dryRun bool) error {
    targets, _ := getDeleteTargets(ctx, retentionDays)

    log.Info("å‰Šé™¤å¯¾è±¡ä»¶æ•°", "count", len(targets))

    if dryRun {
        log.Info("DRY-RUN MODE: å®Ÿéš›ã®å‰Šé™¤ã¯è¡Œã„ã¾ã›ã‚“")
        for _, p := range targets {
            log.Info("å‰Šé™¤å¯¾è±¡",
                "id", p.ID,
                "title", p.Title,
                "removed_at", p.RemovedAt)
        }
        return nil
    }

    // å®Ÿéš›ã®å‰Šé™¤å‡¦ç†...
}
```

**å®Ÿè¡Œä¾‹**:
```bash
# åˆå›ã¯dry-runã§ç¢ºèª
go run cmd/batch/main.go physical-delete --retention-days=90 --dry-run

# å•é¡Œãªã‘ã‚Œã°æœ¬å®Ÿè¡Œ
go run cmd/batch/main.go physical-delete --retention-days=90
```

---

## é‹ç”¨ãƒ•ãƒ­ãƒ¼

### åˆæœŸé‹ç”¨ï¼ˆã€œ6ãƒ¶æœˆï¼‰

```yaml
retention_days: 90
schedule: "é€±1å›ï¼ˆæ—¥æ›œæ·±å¤œï¼‰"
dry_run: true  # æœ€åˆã®1ãƒ¶æœˆ
alert: enabled
```

### å®‰å®šé‹ç”¨ï¼ˆ6ãƒ¶æœˆã€œï¼‰

```yaml
retention_days: 30
schedule: "é€±1å›ï¼ˆæ—¥æ›œæ·±å¤œï¼‰"
dry_run: false
alert: enabled
```

### å¤§è¦æ¨¡é‹ç”¨ï¼ˆãƒ‡ãƒ¼ã‚¿é‡10GBè¶…ï¼‰

```yaml
retention_days: 7
schedule: "æ¯æ—¥æ·±å¤œ"
batch_size: 1000  # åˆ†å‰²å‰Šé™¤
alert: enabled
```

---

## MySQL ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­è¨ˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### daily_property_snapshots ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³

```sql
CREATE TABLE daily_property_snapshots (
    snapshot_date DATE NOT NULL,
    property_id VARCHAR(32) NOT NULL,
    detail_url TEXT NOT NULL,
    area_code VARCHAR(20),
    PRIMARY KEY (snapshot_date, property_id)
)
PARTITION BY RANGE (TO_DAYS(snapshot_date)) (
    PARTITION p202512 VALUES LESS THAN (TO_DAYS('2026-01-01')),
    PARTITION p202601 VALUES LESS THAN (TO_DAYS('2026-02-01')),
    PARTITION p202602 VALUES LESS THAN (TO_DAYS('2026-03-01')),
    PARTITION pfuture VALUES LESS THAN MAXVALUE
);
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- å¤ã„ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãŒé«˜é€Ÿï¼ˆDROP PARTITIONï¼‰
- ã‚¯ã‚¨ãƒªæ€§èƒ½å‘ä¸Šï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ»ãƒ—ãƒ«ãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰

**å‰Šé™¤ä¾‹**:
```sql
-- 90æ—¥ä»¥å‰ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
ALTER TABLE daily_property_snapshots DROP PARTITION p202512;
```

---

## ã“ã®è¨­è¨ˆã®ãƒ¡ãƒªãƒƒãƒˆã¾ã¨ã‚

* âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿ã¯å³æ™‚** - è«–ç†å‰Šé™¤ã§æ¤œç´¢çµæœã‹ã‚‰å³é™¤å¤–
* âœ… **ãƒ‡ãƒ¼ã‚¿äº‹æ•…ã‚’é˜²ã’ã‚‹** - 30ã€œ90æ—¥ã®çŒ¶äºˆæœŸé–“
* âœ… **ãƒ‡ãƒ¼ã‚¿é‡ã¯ç·šå½¢ã«æŠ‘åˆ¶** - ç„¡é™å¢—åŠ ã‚’é˜²ã
* âœ… **å°†æ¥ã®åˆ†æãƒ»å¾©å…ƒãŒå¯èƒ½** - delete_logsã§è¿½è·¡
* âœ… **é‹ç”¨ãŒå˜ç´”** - é€±1å›ãƒãƒƒãƒã§è‡ªå‹•åŒ–

---

## ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

### ç›£è¦–ã™ã¹ããƒ¡ãƒˆãƒªã‚¯ã‚¹

```go
// å‰Šé™¤æ¸ˆã¿ç‰©ä»¶ã®å‰²åˆ
removed_ratio = removed_count / total_count

// ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶
if removed_ratio > 0.5 {
    alert("å‰Šé™¤æ¸ˆã¿ç‰©ä»¶ãŒ50%è¶…: ãƒ‡ãƒ¼ã‚¿é‡å‰Šæ¸›ã‚’æ¤œè¨")
}

// ç‰©ç†å‰Šé™¤ä»¶æ•°
if deleted_count > 10000 {
    alert("ç‰©ç†å‰Šé™¤ãŒ1ä¸‡ä»¶è¶…: ç•°å¸¸ã®å¯èƒ½æ€§")
}
```

---

## ã‚ˆãã‚ã‚‹è³ªå•

### Q1. è«–ç†å‰Šé™¤ã ã‘ã§ã„ã„ã®ã§ã¯ï¼Ÿ

**A**: åˆæœŸã¯è«–ç†å‰Šé™¤ã®ã¿ã§OKã€‚ãŸã ã—ä»¥ä¸‹ã®å ´åˆã¯ç‰©ç†å‰Šé™¤ãŒå¿…è¦ï¼š
- ãƒ‡ãƒ¼ã‚¿é‡ãŒ10GBè¶…
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆãŒèª²é¡Œ
- ã‚¯ã‚¨ãƒªæ€§èƒ½ãŒåŠ£åŒ–

### Q2. ç‰©ç†å‰Šé™¤ã§å¾©æ´»ã§ããªããªã‚‹ã®ã§ã¯ï¼Ÿ

**A**: `delete_logs` ã«è¨˜éŒ²ã•ã‚Œã‚‹ãŸã‚ã€ä»¥ä¸‹ãŒå¯èƒ½ï¼š
- å‰Šé™¤å±¥æ­´ã®ç¢ºèª
- çµ±è¨ˆãƒ»åˆ†æ
- å°†æ¥ã®å†ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ™‚ã«å‚ç…§

### Q3. å‰Šé™¤é »åº¦ã¯ï¼Ÿ

**A**: æ¨å¥¨ï¼š
- åˆæœŸ: é€±1å›ï¼ˆæ—¥æ›œæ·±å¤œï¼‰
- å®‰å®š: é€±1å›
- å¤§è¦æ¨¡: æ¯æ—¥ï¼ˆåˆ†å‰²å‰Šé™¤ï¼‰

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… **Phase 2ã§è«–ç†å‰Šé™¤ã‚’å®Ÿè£…**
2. â³ **Phase 4ã§ç‰©ç†å‰Šé™¤ãƒãƒƒãƒã‚’è¿½åŠ **
3. â³ **delete_logsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**
4. â³ **dry-runãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆ**
5. â³ **é‹ç”¨1ãƒ¶æœˆå¾Œã«æœ¬å®Ÿè¡Œ**

---

## æœ€å¾Œã«ï¼ˆé‡è¦ï¼‰

**ã€Œæœ€åˆã‹ã‚‰ç‰©ç†å‰Šé™¤ã—ãªã„ã€åˆ¤æ–­ã¯æ­£ã—ã„**ã§ã™ã€‚

å‰Šé™¤ã¯ **"æ—©ã•"ã‚ˆã‚Š"ç¢ºå®Ÿã•"** ãŒé‡è¦ã€‚

### åŸå‰‡

1. **è«–ç†å‰Šé™¤ = å³æ™‚**
2. **ä¿ç•™æœŸé–“ = æœ€ä½30æ—¥**
3. **ç‰©ç†å‰Šé™¤ = æ…é‡ã«**

ã“ã®3æ®µéšã‚’å®ˆã‚Œã°ã€ãƒ‡ãƒ¼ã‚¿äº‹æ•…ã¯ã»ã¼é˜²ã’ã¾ã™ã€‚

---

**æœ€çµ‚æ›´æ–°**: 2025-12-16
