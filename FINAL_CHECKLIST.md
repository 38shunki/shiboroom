# æœ€çµ‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ - é‹ç”¨é–‹å§‹å‰ã®ç¢ºèª

**ä½œæˆæ—¥**: 2025-12-22 23:40 JST
**ç›®çš„**: ã“ã®ã¾ã¾GOã§OKã®ç¢ºèª

---

## âœ… ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ï¼ˆç¾åœ¨ï¼‰

### Workerç¨¼åƒçŠ¶æ³
```
âœ… QueueWorker: Started (poll_interval=30s, max_concurrency=1)
âœ… WAF health check: Passed (status: 200)
âœ… DetailLimiter: 5/5 used in last hour (æ­£å¸¸å¾…æ©Ÿä¸­)
âœ… æ¬¡ã®å‡¦ç†: ç´„40åˆ†å¾Œï¼ˆ15:12é ƒï¼‰
```

### ã‚­ãƒ¥ãƒ¼çŠ¶æ…‹
```json
{
  "pending": 2,           // â† æ–°URLå¾…æ©Ÿä¸­
  "processing": 16,       // â† Workerå¾…æ©Ÿä¸­
  "permanent_fail": 5,    // â† æ—§URLï¼ˆ404ï¼‰
  "done": 0,              // â† ã¾ã 0ï¼ˆæ–°URLå¾…ã¡ï¼‰
  "failed": 0,
  "is_running": true
}
```

### WAFæ¤œçŸ¥
```
âœ… èµ·å‹•æ™‚ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: åˆæ ¼
âœ… å‡¦ç†ä¸­ã®WAFæ¤œçŸ¥: 0å›
âœ… Circuit Breaker: Open ãªã—
```

### 404å‡¦ç†
```
âœ… 5ä»¶å…¨ã¦ permanent_fail ã«è¨­å®š
âœ… ãƒªãƒˆãƒ©ã‚¤ãªã—ï¼ˆè¨­è¨ˆé€šã‚Šï¼‰
âœ… æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã¸è‡ªå‹•é·ç§»
```

---

## ğŸ”’ è¨­è¨ˆã®å®Œæˆåº¦ç¢ºèª

### è²¬å‹™åˆ†é›¢
- [x] Scheduler: ã‚­ãƒ¥ãƒ¼æŠ•å…¥ã®ã¿ï¼ˆç›´æ¥scrapeãªã—ï¼‰
- [x] Worker: å”¯ä¸€ã®è©³ç´°å–å¾—å®Ÿè¡Œè€…
- [x] DetailLimiter: ç¢ºå®Ÿã«é©ç”¨ï¼ˆ5ä»¶/æ™‚å³å®ˆï¼‰
- [x] `/api/scrape/list`: ã‚­ãƒ¥ãƒ¼æŠ•å…¥ã®ã¿

### å®‰å…¨æ©Ÿæ§‹
- [x] WAFãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ4hâ†’4hâ†’12hï¼‰
- [x] DetailLimiterï¼ˆ5ä»¶/æ™‚ï¼‰
- [x] äºˆé˜²åœæ­¢ï¼ˆ3æˆåŠŸâ†’5min pauseï¼‰
- [x] Circuit Breakerï¼ˆ8/20ã§é–‹æ”¾ï¼‰
- [x] äººé–“ã‚‰ã—ã„å¾…æ©Ÿï¼ˆ45-120ç§’ï¼‰

### ã‚¨ãƒ©ãƒ¼å‡¦ç†
- [x] 404 â†’ permanent_failï¼ˆå³çµ‚äº†ï¼‰
- [x] WAF â†’ cooldown 1h + pause 5m
- [x] ä¸€èˆ¬ã‚¨ãƒ©ãƒ¼ â†’ exponential backoff
- [x] æœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤

### ç›£è¦–ãƒ»é‹ç”¨
- [x] daily_check.shï¼ˆ1è¡Œã‚µãƒãƒªãƒ¼ï¼‰
- [x] scraping_diagnosis.shï¼ˆãƒˆãƒ©ãƒ–ãƒ«è¨ºæ–­ï¼‰
- [x] /api/queue/statsï¼ˆAPIç›£è¦–ï¼‰
- [x] è©³ç´°ãƒ­ã‚°ï¼ˆcaller/next_epoch/wait_secï¼‰

---

## ğŸ“Š è©•ä¾¡åŸºæº–ï¼ˆå†ç¢ºèªï¼‰

### 24æ™‚é–“å¾Œã®åˆæ ¼ãƒ©ã‚¤ãƒ³
```
Done: 100-120ä»¶ï¼ˆ5ä»¶/æ™‚ Ã— 24hï¼‰
PermanentFailç‡: <10%
WAFæ¤œçŸ¥: 0å›
Pending: 0-50ä»¶ï¼ˆå®‰å®šï¼‰
Worker: is_running=trueï¼ˆç¶™ç¶šï¼‰
```

### 1é€±é–“å¾Œã®åˆæ ¼ãƒ©ã‚¤ãƒ³
```
Done: 700-840ä»¶
ç‰©ä»¶æ•°: 500-1000ä»¶
PermanentFailç‡: <10%
WAFæ¤œçŸ¥: 0å›
Pending: å¢—ãˆç¶šã‘ãªã„
```

---

## ğŸ”’ çµ¶å¯¾ã«å®ˆã‚‹ãƒ«ãƒ¼ãƒ«

### âŒ ç¦æ­¢äº‹é …ï¼ˆç†ç”±ä»˜ãï¼‰

| è¡Œç‚º | ç†ç”± |
|------|------|
| DetailLimiter ã‚’ç·©ã‚ã‚‹ | WAFãƒªã‚¹ã‚¯ãŒè·³ã­ä¸ŠãŒã‚‹ï¼ˆå®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ã‚’å‰Šã‚‹ï¼‰ |
| Worker ã‚’ä¸¦åˆ—åŒ– | DetailLimiter ã®åˆ¶å¾¡ãŒåŠ¹ã‹ãªããªã‚‹ |
| permanent_fail ã‚’ retry ã«æˆ»ã™ | ç„¡é§„ãªãƒªãƒˆãƒ©ã‚¤ã§ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè€— |
| ã€Œèª¿å­ã„ã„ã‹ã‚‰å¤šã‚ã«å›ã™ã€ | **ã“ã‚ŒãŒä¸€ç•ªå±é™º**ï¼ˆWAFå­¦ç¿’ã®é¤Œé£Ÿï¼‰ |

### âœ… æ¨å¥¨äº‹é …

| è¡Œç‚º | é »åº¦ | æ‰€è¦æ™‚é–“ |
|------|------|---------|
| `./daily_check.sh` | æ¯æ—¥ | 10ç§’ |
| Quick Statusç¢ºèª | æ¯æ—¥ | 5ç§’ |
| ãƒ­ã‚°ç¢ºèª | é€±1å› | 5åˆ† |
| çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ | æœˆ1å› | 10åˆ† |

---

## ğŸ¯ æˆåŠŸã®æŒ‡æ¨™

### ã“ã®è¨­è¨ˆãŒã€Œå‹ã¡ã€ã¨ç¢ºå®šã™ã‚‹æ¡ä»¶

**1é€±é–“å¾Œã«ä»¥ä¸‹ã‚’æº€ãŸã›ã°å®Œç’§**:
```
âœ… Done: 700-840ä»¶
âœ… PermanentFailç‡: <10%
âœ… WAF: 0å›
âœ… Pending: å®‰å®šï¼ˆå¢—ãˆç¶šã‘ãªã„ï¼‰
```

**ç†ç”±**:
- 5ä»¶/æ™‚ Ã— 24h Ã— 7æ—¥ = 840ä»¶ãŒç†è«–å€¤
- 700ä»¶ä»¥ä¸Šãªã‚‰83%é”æˆï¼ˆå„ªç§€ï¼‰
- 600ä»¶ä»¥ä¸Šãªã‚‰71%é”æˆï¼ˆåˆæ ¼ï¼‰

---

## ğŸ’¡ ã“ã®è¨­è¨ˆãŒå¼·ã„ç†ç”±

### 1. è²¬å‹™åˆ†é›¢ãŒå®Œç’§
```
Scheduler  â†’ ã‚­ãƒ¥ãƒ¼æŠ•å…¥ï¼ˆè§¦ã‚‰ãªã„ï¼‰
Worker     â†’ è©³ç´°å–å¾—ï¼ˆå”¯ä¸€ã®å®Ÿè¡Œè€…ï¼‰
DetailLimiter â†’ ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡ï¼ˆç¥è–ä¸å¯ä¾µï¼‰
```

### 2. å¤±æ•—ã‚’ã€Œå­¦ç¿’ã€ã«å¤‰ãˆã¦ã„ã‚‹
```
404      â†’ permanent_failï¼ˆå³çµ‚äº†ï¼‰
WAF      â†’ æ®µéšçš„å†·å´ï¼ˆ4hâ†’4hâ†’12hï¼‰
ä¸€èˆ¬ã‚¨ãƒ©ãƒ¼ â†’ exponential backoff
```

### 3. äººé–“ã®æŒ™å‹•ã‚’ã€Œåˆ¶å¾¡ã€ã§å†ç¾
```
äºˆé˜²åœæ­¢     â†’ 3æˆåŠŸâ†’5min pause
ä¸è¦å‰‡ãªå¾…æ©Ÿ  â†’ 45-120ç§’ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ â†’ èµ·å‹•å‰ã«ç¢ºèª
```

### 4. é‹ç”¨ã‚³ã‚¹ãƒˆãŒæ¥µå°
```
ç›£è¦–: 10ç§’/æ—¥ï¼ˆQuick Statusï¼‰
è¨ºæ–­: 3åˆ†ï¼ˆãƒˆãƒ©ãƒ–ãƒ«æ™‚ã®ã¿ï¼‰
æ”¹å–„: ä¸è¦ï¼ˆå®Œæˆå½¢ï¼‰
```

---

## ğŸš€ æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆé‹ç”¨å®‰å®šå¾Œï¼‰

### Phase 1: ãƒ‡ãƒ¼ã‚¿è“„ç©ï¼ˆ1-2é€±é–“ï¼‰
```
ç›®æ¨™: 1000ä»¶ä»¥ä¸Š
ã‚„ã‚‹ã“ã¨: ä½•ã‚‚ã—ãªã„ï¼ˆè¦‹å®ˆã‚‹ã ã‘ï¼‰
```

### Phase 2: å“è³ªæ”¹å–„ï¼ˆ1ãƒ¶æœˆå¾Œï¼‰
```
ã‚¿ã‚¤ãƒˆãƒ«æŠ½å‡ºç²¾åº¦ã®å‘ä¸Š
å®¶è³ƒ/é¢ç©/é§…è·é›¢ã®æ¬ æç‡ä½æ¸›
404åŸå› ã®åˆ†æ
```

### Phase 3: æ©Ÿèƒ½æ‹¡å¼µï¼ˆ2ãƒ¶æœˆå¾Œï¼‰
```
æ¤œç´¢æ¡ä»¶ã®è¿½åŠ 
ã‚¨ãƒªã‚¢åˆ¥çµ±è¨ˆ
ä¾¡æ ¼å¤‰å‹•ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
```

### Phase 4: ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ï¼ˆ3ãƒ¶æœˆå¾Œï¼‰
```
Workerè¤‡æ•°å°å¯¾å¿œ
Redisçµ±åˆï¼ˆlimiterå…±æœ‰ï¼‰
ä»–ã‚µã‚¤ãƒˆå¯¾å¿œï¼ˆSUUMOç­‰ï¼‰
```

---

## ğŸ§  ç·è©•

### ã“ã‚Œã¯ã€Œã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã€ã§ã¯ãªã„

**ã“ã‚Œã¯ã€Œãƒ‡ãƒ¼ã‚¿å–å¾—åŸºç›¤ã€ã§ã™ã€‚**

| ä¸€èˆ¬çš„ãªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° | ã“ã®å®Ÿè£… |
|---------------------|---------|
| é€Ÿåº¦å„ªå…ˆ | å®‰å…¨æ€§å„ªå…ˆ |
| ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰æ­¢ã¾ã‚‹ | ã‚¨ãƒ©ãƒ¼ã‚’å­¦ç¿’ã—ã¦é€²åŒ– |
| æ‰‹å‹•ç›£è¦–ãƒ»æ‰‹å‹•å†èµ·å‹• | è‡ªå‹•ç›£è¦–ãƒ»è‡ªå‹•å¾©å¸° |
| é‹ç”¨ã‚³ã‚¹ãƒˆé«˜ | é‹ç”¨ã‚³ã‚¹ãƒˆæ¥µå° |
| WAFã§å³æ­» | WAFã‚’å›é¿ã—ã¦ç¶™ç¶š |

### å®Œæˆã®ã‚µã‚¤ãƒ³

**ã€Œã“ã‚Œä»¥ä¸Šã®æ”¹å–„ã¯ä¸è¦ã€ã¯å¦¥å”ã§ã¯ãªãã€å®Œæˆã§ã™ã€‚**

ç†ç”±:
- âœ… è²¬å‹™åˆ†é›¢ãŒå®Œç’§
- âœ… ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒå®Œç’§
- âœ… å®‰å…¨æ©Ÿæ§‹ãŒå®Œç’§
- âœ… é‹ç”¨ç›£è¦–ãŒå®Œç’§
- âœ… WAFãƒªã‚¹ã‚¯ãŒæœ€å°
- âœ… æ”¹å–„ä½™åœ°ãŒã€Œé€Ÿåº¦UPã€ã—ã‹ãªã„
  - ã—ã‹ã—é€Ÿåº¦UPã¯**ãƒªã‚¹ã‚¯å¢—**ãªã®ã§ä¸è¦

---

## ğŸ“ é‹ç”¨é–‹å§‹ã®å®£è¨€

**ã“ã®è¨­è¨ˆã¯å®Œæˆå½¢ã§ã™ã€‚**

### å®Œæˆã®è¨¼æ‹ 
```
âœ… Workerç¨¼åƒä¸­
âœ… DetailLimiterå‹•ä½œç¢ºèª
âœ… 404å‡¦ç†å‹•ä½œç¢ºèª
âœ… WAFãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯åˆæ ¼
âœ… äºˆé˜²åœæ­¢å®Ÿè£…æ¸ˆã¿
âœ… 1è¡Œã‚µãƒãƒªãƒ¼å®Ÿè£…æ¸ˆã¿
âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå‚™
âœ… é‹ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Œå‚™
```

### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
```
1. ä½•ã‚‚ã—ãªã„ï¼ˆè¦‹å®ˆã‚‹ï¼‰
2. 24æ™‚é–“å¾Œ: daily_check.sh
3. 1é€±é–“å¾Œ: åˆæ ¼ãƒ©ã‚¤ãƒ³ç¢ºèª
4. ãã‚Œä»¥é™: é€±1å›ã®ç¢ºèªã®ã¿
```

### æ”¹å–„ã®åˆ¤æ–­åŸºæº–
**ã€Œãã‚Œã¯æœ¬å½“ã«å¿…è¦ã‹ï¼Ÿã€**

ä»¥ä¸‹ã®ã‚ˆã†ãªææ¡ˆã¯**å…¨ã¦å´ä¸‹**:
- ã€Œé€Ÿåº¦ã‚’ä¸Šã’ãŸã„ã€ â†’ WAFãƒªã‚¹ã‚¯å¢—ï¼ˆå´ä¸‹ï¼‰
- ã€Œä¸¦åˆ—åŒ–ã—ãŸã„ã€ â†’ è¤‡é›‘åŒ–ï¼ˆå´ä¸‹ï¼‰
- ã€Œãƒªãƒˆãƒ©ã‚¤ã‚’å¢—ã‚„ã—ãŸã„ã€ â†’ ç„¡é§„ï¼ˆå´ä¸‹ï¼‰

---

## ğŸŠ æœ€å¾Œã«

### ã‚ãªãŸï¼ˆé–‹ç™ºè€…ï¼‰ã¸

**æœ¬å½“ã«ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚**

ã“ã“ã¾ã§ã®é“ã®ã‚Š:
1. åˆæœŸå®Ÿè£…ï¼ˆåŸºæœ¬æ©Ÿèƒ½ï¼‰
2. WAFç™ºå‹•ï¼ˆå­¦ç¿’ï¼‰
3. è¨­è¨ˆè¦‹ç›´ã—ï¼ˆScheduler/Workeråˆ†é›¢ï¼‰
4. DetailLimiterçµ±ä¸€
5. 404å‡¦ç†çµ±ä¸€
6. WAFãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¿½åŠ 
7. äºˆé˜²åœæ­¢è¿½åŠ 
8. é‹ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åŒ–
9. **å®Œæˆ**

### ã“ã®å®Ÿè£…ã®ä¾¡å€¤

**æŠ€è¡“çš„ä¾¡å€¤**:
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹çš„ãªè²¬å‹™åˆ†é›¢
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®æ­£ã—ã„å®Ÿè£…
- ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å®Œç’§ãªåˆ†é¡
- é‹ç”¨ç›£è¦–ã®æœ€å°åŒ–

**ãƒ“ã‚¸ãƒã‚¹çš„ä¾¡å€¤**:
- æ­¢ã¾ã‚‰ãªã„ãƒ‡ãƒ¼ã‚¿å–å¾—
- WAFãƒªã‚¹ã‚¯ã®æœ€å°åŒ–
- é‹ç”¨ã‚³ã‚¹ãƒˆæ¥µå°ï¼ˆ10ç§’/æ—¥ï¼‰
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªè¨­è¨ˆ

**æ•™è‚²çš„ä¾¡å€¤**:
- ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã®æ•™ç§‘æ›¸
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…ä¾‹
- é‹ç”¨ç›£è¦–ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

---

## âœ… GOåˆ¤å®š

**ã“ã®ã¾ã¾é‹ç”¨é–‹å§‹ã—ã¦OKã§ã™ã€‚**

ç†ç”±:
- ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯é …ç›®ãŒ âœ…
- WAFãƒªã‚¹ã‚¯ãŒæœ€å°åŒ–ã•ã‚Œã¦ã„ã‚‹
- é‹ç”¨ã‚³ã‚¹ãƒˆãŒæ¥µå°
- æ”¹å–„ä½™åœ°ãŒã€Œé€Ÿåº¦UPï¼ˆä¸è¦ï¼‰ã€ã®ã¿

**æ¬¡ã¯24æ™‚é–“å¾Œã« `./daily_check.sh` ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã™ã€‚**

---

**é‹ç”¨é–‹å§‹ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼** ğŸŠğŸš€

---

**æœ€çµ‚æ›´æ–°**: 2025-12-22 23:40 JST
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **é‹ç”¨å¯èƒ½**
**æ¬¡å›ç¢ºèª**: 24æ™‚é–“å¾Œï¼ˆQuick Statusï¼‰
