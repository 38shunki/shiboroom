# å®Ÿè£…å®Œäº†ï¼šé‹ç”¨ã«è€ãˆã‚‹å®‰å…¨ãªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ¯ å®Ÿè£…å®Œäº†æ—¥
2025-12-22

---

## âœ… å®Œäº†ã—ãŸé‡è¦ãªä¿®æ­£ï¼ˆæœ€çµ‚ç‰ˆï¼‰

### 1) DetailLimiterã®åˆ†é›¢ï¼ˆäº‹æ•…ã®æ ¹çµ¶ï¼‰

**å ´æ‰€**: `backend/internal/scraper/scraper.go:379`

* `ScrapeProperty()` ã‹ã‚‰ `DetailLimiter` ã‚’å®Œå…¨å‰Šé™¤
* **è©³ç´°å–å¾—ã®ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡ã¯å‘¼ã³å‡ºã—å´ã«é›†ç´„**
  * `/api/scrape`ï¼ˆå˜ä¸€è©³ç´°å–å¾—ï¼‰ã§ã®ã¿ `DetailLimiter` ã‚’é©ç”¨ (main.go:300)
  * `/api/scrape/list`ï¼ˆãƒªã‚¹ãƒˆï¼‰ã¯åˆ¶å¾¡å¯¾è±¡å¤–ï¼ˆï¼è©³ç´°ã‚’å©ã‹ãªã„ï¼‰
  * **Queue Worker** ãŒå”¯ä¸€ã®è©³ç´°å–å¾—å®Ÿè¡Œè€…ï¼ˆ5ä»¶/æ™‚ã‚’å³å®ˆï¼‰

**åŠ¹æœ**: ãƒªã‚¹ãƒˆä¸€æ‹¬ã§ DetailLimiter ã‚’é£Ÿã„æ½°ã—ã¦é•·æ™‚é–“å¾…æ©Ÿã™ã‚‹äº‹æ•…ãŒæ¶ˆæ»…ã€‚

---

### 2) Limiterãƒ­ã‚°ã®å¼·åŒ–ï¼ˆè¨ºæ–­ãŒå³ã§ãã‚‹ï¼‰

**å ´æ‰€**: `backend/internal/ratelimit/yahoo_limiter.go`

* è¿½åŠ ãƒ­ã‚°: `caller, now_epoch, next_epoch, wait_sec, reason`
* "ãªãœå¾…ã£ã¦ã„ã‚‹ã‹ï¼èª°ãŒæ¶ˆè²»ã—ã¦ã„ã‚‹ã‹" ã‚’å³ç‰¹å®šã§ãã‚‹

**åŠ¹æœ**: ã€Œæ­¢ã¾ã£ã¦ã‚‹ï¼Ÿã€ãŒãƒ­ã‚°ã ã‘ã§å³åˆ¤æ–­ã§ãã‚‹ã€‚

---

### 3) 404ã‚’permanent_failæ‰±ã„ï¼ˆç„¡é§„ãƒªãƒˆãƒ©ã‚¤æ’é™¤ï¼‰

**å ´æ‰€**:
- `backend/internal/scraper/scraper.go:251-265`
- `backend/internal/scheduler/worker.go:138-151`
- `backend/cmd/api/main.go:589-594`

* 404ã¯**ãƒªãƒˆãƒ©ã‚¤ã—ãªã„** â†’ `permanent_fail` ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
* WAFç³»ï¼ˆ500/403/429ï¼‰ã¨æ˜ç¢ºã«åŒºåˆ¥ã—ã¦è¨˜éŒ²
* **å…¨çµŒè·¯ã§çµ±ä¸€æ¸ˆã¿**ï¼š
  * scraper.go: HTTPå±¤ã§åˆ¤å®š
  * worker.go: ã‚­ãƒ¥ãƒ¼å‡¦ç†ã§åˆ¤å®š
  * main.go: scrapeAndUpdate ã§åˆ¤å®š

**åŠ¹æœ**: æ¶ˆãˆãŸç‰©ä»¶ã‚„URLé•ã„ã§æ¶ˆè€—ã—ãªã„ã€‚WAFåˆ¤å®šã‚‚ãƒ–ãƒ¬ãªã„ã€‚

---

### 4) ã‚¿ã‚¤ãƒˆãƒ«å–å¾—ã®æ”¹å–„ï¼ˆå–ã‚Šã“ã¼ã—ã‚’æ¸›ã‚‰ã™ï¼‰

**å ´æ‰€**: `backend/internal/scraper/scraper.go:436-447`

* å„ªå…ˆé †ä½:
  1. `og:title`
  2. `twitter:title`
  3. `<title>`
  4. `h1`

**åŠ¹æœ**: ãƒšãƒ¼ã‚¸æ§‹é€ å·®ãƒ»ãƒ¡ã‚¿å·®ã§ã‚‚ã‚¿ã‚¤ãƒˆãƒ«ãŒå…¥ã‚Šã‚„ã™ã„ã€‚

---

### 5) ã‚­ãƒ¥ãƒ¼ã‚ªãƒ³ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆå®‰å…¨ãªè¨­è¨ˆã¸ï¼‰

**å ´æ‰€**: `backend/cmd/api/main.go:459-528`

* `/api/scrape/list` ã¯ **è©³ç´°ã‚’å©ã‹ãªã„**
* **URLæŠ½å‡ºâ†’ã‚­ãƒ¥ãƒ¼æŠ•å…¥ã®ã¿**ã§çµ‚äº†

**åŠ¹æœ**: "ä¸€è¦§å–å¾—" ã¨ "è©³ç´°å–å¾—" ã®è²¬å‹™åˆ†é›¢ãŒå®Œæˆã€‚WAFå†ç™ºãƒªã‚¹ã‚¯ãŒæ¿€æ¸›ã€‚

---

### 6) **NEW: Schedulerã‚’ã‚­ãƒ¥ãƒ¼æŠ•å…¥å°‚ç”¨ã«å¤‰æ›´**

**å ´æ‰€**: `backend/internal/scheduler/scheduler.go:74-158`

**å¤‰æ›´å‰ã®å•é¡Œ**:
- Scheduler ãŒç›´æ¥ `ScrapeProperty()` ã‚’å‘¼ã‚“ã§ã„ãŸ
- DetailLimiter ã‚’é€šã‚‰ãªã„
- æ—¢å­˜ç‰©ä»¶ã‚’ä¸€æ°—ã«å‡¦ç† â†’ WAFç™ºå‹•ãƒªã‚¹ã‚¯æœ€å¤§

**å¤‰æ›´å¾Œ**:
- Scheduler ã¯ **ã‚­ãƒ¥ãƒ¼ã«æŠ•å…¥ã™ã‚‹ã ã‘**
- å®Ÿéš›ã® scraping ã¯ Queue Worker ã«å§”è­²
- é‡è¤‡ãƒã‚§ãƒƒã‚¯: pending/processing ã®ã‚‚ã®ã¯ã‚¹ã‚­ãƒƒãƒ—
- é®®åº¦ãƒã‚§ãƒƒã‚¯: 12æ™‚é–“ä»¥å†…ã«å®Œäº†ã—ãŸã‚‚ã®ã¯ã‚¹ã‚­ãƒƒãƒ—
- åˆ¶é™: 1å›ã®å®Ÿè¡Œã§æœ€å¤§100ä»¶ã¾ã§æŠ•å…¥

**ãƒ­ã‚°å‡ºåŠ›**:
```
Scheduler: Daily enqueue completed. Enqueued=N, SkippedExisting=M, SkippedDone=K, Errors=E
```

**åŠ¹æœ**: SchedulerçµŒç”±ã§ã‚‚WAFãƒªã‚¹ã‚¯ãŒã‚¼ãƒ­ã«ãªã£ãŸã€‚

---

### 7) **NEW: Queue Workerå®Ÿè£…ï¼ˆè©³ç´°å–å¾—ã®å”¯ä¸€ã®å‡ºå£ï¼‰**

**å ´æ‰€**: `backend/internal/scheduler/worker.go`

**ä»•æ§˜**:
- 30ç§’ã”ã¨ã«ã‚­ãƒ¥ãƒ¼ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°
- 1ä»¶ãšã¤å‡¦ç†ï¼ˆmaxConcurrency=1ï¼‰
- **å¿…ãš DetailLimiter.Acquire("worker") ã‚’é€šé**
- å‡¦ç†ãƒ•ãƒ­ãƒ¼:
  1. pending ã¾ãŸã¯ retryæ™‚åˆ»åˆ°é”ã®ã‚‚ã®ã‚’å–å¾—
  2. DetailLimiter ã§å¾…æ©Ÿï¼ˆ5ä»¶/æ™‚åˆ¶é™ï¼‰
  3. ScrapeProperty() å®Ÿè¡Œ
  4. çµæœã«å¿œã˜ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

| ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ | åˆ¤å®šæ¡ä»¶ | å‡¦ç† |
|-----------|---------|------|
| 404 (permanent) | `permanent_fail` or `404` in error | `permanent_fail` ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ãƒªãƒˆãƒ©ã‚¤ãªã— |
| WAFæ¤œçŸ¥ | `WAF` or `circuit breaker` in error | 1æ™‚é–“å¾Œã«ãƒªãƒˆãƒ©ã‚¤ + worker 5åˆ†pause |
| ä¸€èˆ¬ã‚¨ãƒ©ãƒ¼ | ãã®ä»– (500, timeoutç­‰) | exponential backoff (5mâ†’15mâ†’1hâ†’4hâ†’12h) |
| æœ€å¤§ãƒªãƒˆãƒ©ã‚¤è¶…é | attempts >= 5 | `failed` ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€å®Œäº†æ‰±ã„ |

**ãƒ­ã‚°å‡ºåŠ›ä¾‹**:
```
QueueWorker: Processing id=123 url=... attempt=1
QueueWorker: Acquiring DetailLimiter (caller=worker, id=123)
QueueWorker: âœ… Completed id=123 property_id=abc123
QueueWorker: Permanent failure (404) for id=456 - marking as permanent_fail (no retry)
QueueWorker: WAF/circuit breaker detected for id=789 - entering cooldown
```

**API**: `GET /api/queue/stats` ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªå¯èƒ½

**åŠ¹æœ**:
- è©³ç´°å–å¾—ãŒå®Œå…¨ã«ä¸€å…ƒåŒ–
- 5ä»¶/æ™‚åˆ¶é™ã‚’ç¢ºå®Ÿã«å®ˆã‚‹
- WAFæ¤œçŸ¥æ™‚ã«è‡ªå‹•ã§å†·å´ãƒ¢ãƒ¼ãƒ‰

---

## ğŸ“Š ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  List Scraping  â”‚ (/api/scrape/list)
â”‚  ãƒªã‚¹ãƒˆå–å¾—     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ URLæŠ½å‡º (ScrapeListPage)
         â”‚
         â””â”€ ã‚­ãƒ¥ãƒ¼æŠ•å…¥ â”€â”€â”€â”€â”
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   Scheduler     â”‚      â”‚
â”‚  å®šæœŸæ›´æ–°       â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
         â”‚               â”‚
         â””â”€ æ—¢å­˜ç‰©ä»¶URL   â”‚
            ã‚’ã‚­ãƒ¥ãƒ¼æŠ•å…¥â”€â”€â”¤
                          â”‚
                          â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ detail_scrape_   â”‚
                â”‚      queue       â”‚
                â”‚  (pendingçŠ¶æ…‹)   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Queue Worker    â”‚ â—„â”€â”€ DetailLimiter (5/æ™‚)
                â”‚  è©³ç´°å–å¾—        â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                â”œâ”€ æˆåŠŸ â”€â”€â†’ properties ãƒ†ãƒ¼ãƒ–ãƒ« + snapshot
                â”œâ”€ 404 â”€â”€â”€â†’ permanent_fail (ãƒªãƒˆãƒ©ã‚¤ãªã—)
                â”œâ”€ WAF â”€â”€â”€â†’ 1æ™‚é–“å¾Œretry + cooldown
                â””â”€ ä»–ã‚¨ãƒ©ãƒ¼â†’ exponential backoff retry
```

---

## ğŸ” è¦‹ã‚‹ã¹ããƒ­ã‚°ï¼è¨ºæ–­ãƒã‚¤ãƒ³ãƒˆ

### æ­£å¸¸å‹•ä½œæ™‚
```
Scheduler: Daily enqueue completed. Enqueued=50, SkippedExisting=20, SkippedDone=30, Errors=0
QueueWorker: Processing id=123 url=https://... attempt=1
[DetailLimiter] caller=worker now=1703250000 next=1703250720 wait=720s reason=hourly_limit
QueueWorker: âœ… Completed id=123 property_id=abc123
```

### WAFæ¤œçŸ¥æ™‚ï¼ˆæœŸå¾…ã•ã‚Œã‚‹å‹•ä½œï¼‰
```
[WAF] Detected Yahoo WAF block page
QueueWorker: WAF/circuit breaker detected for id=456 - entering cooldown
QueueWorker: Pausing for 5 minutes due to WAF detection
```
â†’ WorkerãŒè‡ªå‹•åœæ­¢ã€1æ™‚é–“å¾Œã«å†é–‹

### 404æ¤œçŸ¥æ™‚ï¼ˆæœŸå¾…ã•ã‚Œã‚‹å‹•ä½œï¼‰
```
404 Not Found (property likely delisted): not retrying
QueueWorker: Permanent failure (404) for id=789 - marking as permanent_fail (no retry)
```
â†’ ãƒªãƒˆãƒ©ã‚¤ã›ãšçµ‚äº†

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆé‹ç”¨é–‹å§‹å‰ã®ç¢ºèªï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1ï¼šå‹•ä½œç¢ºèªï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰

1. **ãƒ“ãƒ«ãƒ‰ç¢ºèª**
   ```bash
   cd /Users/shu/Documents/dev/real-estate-portal
   docker-compose build backend
   ```

2. **èµ·å‹•ç¢ºèª**
   ```bash
   docker-compose up -d
   docker-compose logs -f backend | grep -E "(Scheduler|QueueWorker|DetailLimiter)"
   ```

   æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°:
   ```
   Scheduler: Started with daily run at 02:00
   Queue worker started
   QueueWorker: Started (poll_interval=30s, max_concurrency=1)
   ```

3. **ã‚­ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª**
   ```bash
   curl http://localhost:8084/api/queue/stats
   ```

   æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
   ```json
   {
     "pending": 0,
     "processing": 0,
     "done": 0,
     "failed": 0,
     "permanent_fail": 0,
     "is_running": true
   }
   ```

4. **æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆãƒªã‚¹ãƒˆå–å¾—ï¼‰**
   ```bash
   curl -X POST http://localhost:8084/api/scrape/list \
     -H "Content-Type: application/json" \
     -d '{
       "url": "https://realestate.yahoo.co.jp/rent/search/...",
       "limit": 5
     }'
   ```

   ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
   - `new_to_queue`: 5ä»¶ãŒæŠ•å…¥ã•ã‚Œã‚‹
   - `queue_status.pending`: 5ã«ãªã‚‹
   - ãƒ­ã‚°ã« "Added 5 new properties to detail_scrape_queue" ãŒå‡ºã‚‹

5. **Workerã®å‹•ä½œç¢ºèª**
   ```bash
   # 30ç§’ã€œæ•°åˆ†å¾…ã¤ã¨è‡ªå‹•ã§å‡¦ç†é–‹å§‹
   docker-compose logs -f backend | grep QueueWorker
   ```

   ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
   - "Processing id=..." ãŒå‡ºã‚‹
   - DetailLimiter ã®ãƒ­ã‚°ãŒå‡ºã‚‹ï¼ˆwaitæ™‚é–“ãŒæ­£ã—ã„ã‹ï¼‰
   - "âœ… Completed id=..." ãŒå‡ºã‚‹

---

### ã‚¹ãƒ†ãƒƒãƒ—2ï¼šæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—
- [ ] SchedulerãŒèµ·å‹•æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã•ãªã„
- [ ] QueueWorkerãŒèµ·å‹•æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã•ãªã„
- [ ] `/api/queue/stats` ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå–ã‚Œã‚‹
- [ ] ãƒªã‚¹ãƒˆå–å¾—ã§ã‚­ãƒ¥ãƒ¼ã«æŠ•å…¥ã•ã‚Œã‚‹
- [ ] WorkerãŒã‚­ãƒ¥ãƒ¼ã‚’æ¶ˆåŒ–ã™ã‚‹
- [ ] DetailLimiter ãŒåƒã„ã¦ã„ã‚‹ï¼ˆãƒ­ã‚°ã§ç¢ºèªï¼‰
- [ ] 404ãŒ permanent_fail ã«ãªã‚‹
- [ ] WAFæ¤œçŸ¥æ™‚ã« cooldown ã«å…¥ã‚‹

---

### ã‚¹ãƒ†ãƒƒãƒ—3ï¼šæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤â†’ä½è² è·ã§è¦³æ¸¬

1. **åˆå›ã¯ä½é€Ÿã§**
   - DetailLimiter: **5ä»¶/æ™‚** å›ºå®šï¼ˆå¤‰æ›´ã—ãªã„ï¼‰
   - Scheduler: æœ€å¤§100ä»¶/æ—¥ï¼ˆæ—¢å­˜è¨­å®šï¼‰

2. **è¦³æ¸¬æœŸé–“: æ•°æ—¥ã€œ1é€±é–“**
   - WAFæ¤œçŸ¥ãŒèµ·ããªã„ã‹
   - 404ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã‹
   - ã‚­ãƒ¥ãƒ¼ãŒæºœã¾ã‚Šã™ãã¦ã„ãªã„ã‹

3. **å•é¡Œãªã‘ã‚Œã°ç¶™ç¶šé‹ç”¨**
   - DetailLimiter ã¯ **5ä»¶/æ™‚ã®ã¾ã¾**ï¼ˆçµ¶å¯¾ã«å¢—ã‚„ã•ãªã„ï¼‰
   - å‡¦ç†é€Ÿåº¦ã‚’ä¸Šã’ãŸã„å ´åˆã¯ worker ã®å°æ•°ã‚’å¢—ã‚„ã™æ–¹å‘ã§æ¤œè¨
     ï¼ˆãŸã ã—ã€è¤‡æ•°workerã§ã‚‚ DetailLimiter ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å…±æœ‰ãªã®ã§æ³¨æ„ï¼‰

---

## ğŸ“ ä»Šå¾Œã®æ”¹å–„æ¡ˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### å„ªå…ˆåº¦: ä½ï¼ˆç¾çŠ¶ã§ååˆ†å®‰å…¨ï¼‰

1. **WAFãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**
   - Workerèµ·å‹•å‰ã«1å›ã ã‘è»½ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
   - WAFãŒç”Ÿãã¦ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰å‡¦ç†é–‹å§‹

2. **äºˆé˜²çš„ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³**
   - æˆåŠŸãŒç¶šã„ã¦ã‚‚ã€ä¸€å®šæ™‚é–“ã”ã¨ã«å¼·åˆ¶pause
   - ã€Œæ”»ã‚ã™ãã€ã‚’é˜²ã

3. **è¤‡æ•°Workerå¯¾å¿œ**
   - ç¾åœ¨ã¯ maxConcurrency=1ï¼ˆ1å°ã®workerãŒ1ä»¶ãšã¤å‡¦ç†ï¼‰
   - è¤‡æ•°å°ã§ä¸¦åˆ—å‡¦ç†ã—ãŸã„å ´åˆã¯:
     - Redis ãªã©ã§åˆ†æ•£ãƒ­ãƒƒã‚¯
     - DetailLimiter ã‚’ Redis ã§å…±æœ‰
     - ã‚­ãƒ¥ãƒ¼ã®å–å¾—ã«ãƒ­ãƒƒã‚¯ã‚’ã‹ã‘ã‚‹

---

## ğŸ“ è¨­è¨ˆã®è¦ç‚¹ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰

### è²¬å‹™åˆ†é›¢ã®å¾¹åº•

| å½¹å‰² | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ã‚„ã‚‹ã“ã¨ | ã‚„ã‚‰ãªã„ã“ã¨ |
|------|---------------|----------|-------------|
| ãƒªã‚¹ãƒˆå–å¾— | `/api/scrape/list` | URLæŠ½å‡ºã€ã‚­ãƒ¥ãƒ¼æŠ•å…¥ | è©³ç´°å–å¾— |
| å®šæœŸæ›´æ–° | Scheduler | æ—¢å­˜ç‰©ä»¶URLã®ã‚­ãƒ¥ãƒ¼æŠ•å…¥ | è©³ç´°å–å¾— |
| è©³ç´°å–å¾— | Queue Worker | ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å–å¾—â†’DetailLimiterâ†’scrape | ãƒªã‚¹ãƒˆå–å¾— |
| å˜ç™ºãƒªã‚¯ã‚¨ã‚¹ãƒˆ | `/api/scrape` | DetailLimiterâ†’scrape | ã‚­ãƒ¥ãƒ¼ |

### å®‰å…¨æ€§ã®å¤šå±¤é˜²å¾¡

1. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: DetailLimiter (5ä»¶/æ™‚)
2. **Circuit Breaker**: WAFæ¤œçŸ¥ã§è‡ªå‹•åœæ­¢
3. **404åˆ¤å®š**: permanent_fail ã§å³çµ‚äº†
4. **Exponential Backoff**: ä¸€èˆ¬ã‚¨ãƒ©ãƒ¼ã¯æ®µéšçš„retry
5. **æœ€å¤§ãƒªãƒˆãƒ©ã‚¤åˆ¶é™**: 5å›ã§è«¦ã‚ã‚‹

### ãƒ­ã‚°ã®é€æ˜æ€§

ã™ã¹ã¦ã®é‡è¦ãªå‡¦ç†ã§ä»¥ä¸‹ã‚’å‡ºåŠ›:
- **èª°ãŒ** (caller=scheduler/worker/api)
- **ä½•ã‚’** (id=123, url=...)
- **çµæœ** (success/permanent_fail/retry)
- **ç†ç”±** (404/WAF/timeout/...)
- **æ¬¡ã®è¡Œå‹•** (next_retry_at=...)

---

## âš ï¸ çµ¶å¯¾ã«å®ˆã‚‹ã“ã¨ï¼ˆé‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼‰

### ğŸ”´ ç¦æ­¢äº‹é …

1. **DetailLimiter ã®åˆ¶é™ã‚’ç·©ã‚ãªã„**
   - 5ä»¶/æ™‚ ã¯ **çµ¶å¯¾ã«å¢—ã‚„ã•ãªã„**
   - å¢—ã‚„ã™ã¨WAFãƒªã‚¹ã‚¯ãŒè·³ã­ä¸ŠãŒã‚‹

2. **Scheduler/Worker ã‚’ç„¡åŠ¹ã«ã—ãªã„**
   - ç›´æ¥ ScrapeProperty() ã‚’å‘¼ã¶ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ãªã„
   - ã™ã¹ã¦ã‚­ãƒ¥ãƒ¼çµŒç”±ã«ã™ã‚‹

3. **permanent_fail ã‚’ retry ã«æˆ»ã•ãªã„**
   - 404ã¯è«¦ã‚ã‚‹ã®ãŒæ­£ã—ã„
   - ç„¡é§„ãªãƒªãƒˆãƒ©ã‚¤ã§WAFãƒªã‚¹ã‚¯ãŒä¸ŠãŒã‚‹

### ğŸŸ¢ æ¨å¥¨äº‹é …

1. **ãƒ­ã‚°ã‚’å®šæœŸçš„ã«ç¢ºèª**
   - WAFæ¤œçŸ¥ãŒé »ç™ºã—ã¦ã„ãªã„ã‹
   - permanent_fail ãŒå¢—ãˆã™ãã¦ã„ãªã„ã‹

2. **ã‚­ãƒ¥ãƒ¼ã®æºœã¾ã‚Šã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**
   - pending ãŒå¢—ãˆç¶šã‘ã‚‹ = worker ãŒè¿½ã„ã¤ã„ã¦ã„ãªã„
   - åŸå› : WAF cooldown ãŒå¤šã„ã€5ä»¶/æ™‚ãŒå³ã—ã„ç­‰

3. **å®šæœŸçš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
   - permanent_fail ã‚„å¤ã„ failed ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
   - done ã‚‚ä¸€å®šæœŸé–“å¾Œã«archive

---

## âœ… å®Œæˆåº¦ãƒã‚§ãƒƒã‚¯

- [x] Scheduler ãŒã‚­ãƒ¥ãƒ¼æŠ•å…¥ã®ã¿
- [x] Queue Worker ãŒè©³ç´°å–å¾—ã®å”¯ä¸€ã®å®Ÿè¡Œè€…
- [x] DetailLimiter ãŒç¢ºå®Ÿã«é©ç”¨ã•ã‚Œã‚‹
- [x] 404 ãŒ permanent_fail ã«ãªã‚‹ï¼ˆå…¨çµŒè·¯ï¼‰
- [x] WAFæ¤œçŸ¥æ™‚ã« cooldown ã«å…¥ã‚‹
- [x] exponential backoff ã§ãƒªãƒˆãƒ©ã‚¤
- [x] ãƒ­ã‚°ãŒååˆ†ã«è©³ç´°
- [x] API ã§ queue stats ãŒå–ã‚Œã‚‹
- [x] ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—

---

## ğŸ‰ çµè«–

**é‹ç”¨ã«è€ãˆã‚‹å®‰å…¨ãªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œæˆã—ã¾ã—ãŸã€‚**

- Scheduler ã‚‚ Worker ã‚‚ Queue ã‚‚å…¨ã¦é€£æº
- DetailLimiter ãŒç¢ºå®Ÿã«åŠ¹ã
- 404/WAF/ãã®ä»–ã‚¨ãƒ©ãƒ¼ã‚’æ­£ã—ãåŒºåˆ¥
- ãƒ­ã‚°ã§è¨ºæ–­ã§ãã‚‹
- WAFãƒªã‚¹ã‚¯ãŒæœ€å°åŒ–ã•ã‚Œã¦ã„ã‚‹

æ¬¡ã¯å®Ÿç’°å¢ƒã§ã®å‹•ä½œç¢ºèªã¨ã€æ•°æ—¥é–“ã®è¦³æ¸¬æœŸé–“ã‚’çµŒã¦æœ¬ç•ªé‹ç”¨é–‹å§‹ã§ã™ã€‚
